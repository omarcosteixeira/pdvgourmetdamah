<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gourmet da Mah - PDV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --main-color: #be185d;
        }
        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex-grow: 1;
        }
        .section {
            display: none;
        }
        .active-section {
            display: block;
        }
        .sidebar-link.active {
            background-color: var(--main-color);
            color: white;
            opacity: 0.8;
        }
        .sidebar-link:hover {
            transform: scale(1.05);
        }
        .branding-font {
            font-family: 'Pacifico', cursive;
        }
        .landing-page-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row">

    <!-- Landing Page (Login/Registration) -->
    <section id="landing-page" class="flex-1 flex flex-col items-center justify-center p-8 text-center min-h-screen transition-opacity duration-500">
        <h1 class="text-6xl font-bold text-gray-900 branding-font mb-4">Gourmet da Mah</h1>
        <p class="text-xl text-gray-600 mb-8">Acesse seu sistema de PDV.</p>
        
        <div id="auth-container" class="w-full max-w-sm bg-white p-8 rounded-3xl shadow-xl space-y-4">
            <!-- Login Form -->
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="sr-only">E-mail</label>
                    <input type="email" id="login-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200" placeholder="E-mail" required>
                </div>
                <div>
                    <label for="login-password" class="sr-only">Senha</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200" placeholder="Senha" required>
                </div>
                <button type="submit" class="w-full px-8 py-3 bg-pink-500 text-white rounded-xl font-bold text-lg hover:bg-pink-600 transition-colors duration-200 shadow-lg transform hover:scale-105">
                    Entrar
                </button>
            </form>

            <!-- Registration Form (hidden by default) -->
            <form id="register-form" class="hidden space-y-4">
                <p class="text-lg font-semibold text-gray-700">Primeiro Cadastro</p>
                <div>
                    <label for="register-email" class="sr-only">E-mail</label>
                    <input type="email" id="register-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200" placeholder="E-mail" required>
                </div>
                <div>
                    <label for="register-password" class="sr-only">Senha</label>
                    <input type="password" id="register-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent transition-all duration-200" placeholder="Senha" required>
                </div>
                <button type="submit" class="w-full px-8 py-3 bg-fuchsia-500 text-white rounded-xl font-bold text-lg hover:bg-fuchsia-600 transition-colors duration-200 shadow-lg transform hover:scale-105">
                    Cadastrar
                </button>
            </form>
            
            <div class="mt-4">
                <a href="#" id="toggle-form-link" class="text-sm text-gray-500 hover:text-pink-500 transition-colors duration-200">Não tem uma conta? Crie uma aqui.</a>
            </div>
        </div>
    </section>

    <!-- Main App Container - Starts hidden -->
    <div id="main-app-container" class="hidden flex-1 flex flex-col md:flex-row">
        <!-- Sidebar -->
        <aside class="w-64 bg-gradient-to-br from-rose-500 to-fuchsia-600 text-white min-h-screen p-6 shadow-xl" id="sidebar-bg">
            <div class="text-3xl font-bold mb-8 branding-font" id="sidebar-branding">Gourmet da Mah</div>
            <nav class="flex flex-col h-full">
                <ul class="flex-1">
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="dashboard"><i class="fa-solid fa-house mr-3"></i>Início</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="vendas"><i class="fa-solid fa-cash-register mr-3"></i>Vendas</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="historico"><i class="fa-solid fa-clock-rotate-left mr-3"></i>Histórico</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="estoque"><i class="fa-solid fa-box-open mr-3"></i>Estoque</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="clientes"><i class="fa-solid fa-users mr-3"></i>Clientes</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="lembretes"><i class="fa-solid fa-calendar-check mr-3"></i>Lembretes</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="financeiro"><i class="fa-solid fa-sack-dollar mr-3"></i>Financeiro</a></li>
                    <li><a href="#" class="sidebar-link flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200 mb-2" data-section="configuracoes"><i class="fa-solid fa-cog mr-3"></i>Configurações</a></li>
                </ul>
                <div class="mt-auto pt-4 border-t border-rose-400">
                    <a href="#" id="logout-link" class="flex items-center p-3 rounded-lg text-rose-100 hover:bg-rose-400 transition-all duration-200"><i class="fa-solid fa-right-from-bracket mr-3"></i>Sair</a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 main-content">

            <!-- Modals for success and PDF generation -->
            <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                <div class="bg-white rounded-lg p-6 shadow-xl w-80">
                    <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                    <p id="modal-message" class="text-gray-700 mb-6"></p>
                    <div class="flex justify-end space-x-2">
                        <button id="modal-close" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Fechar</button>
                        <a id="modal-pdf-link" href="#" target="_blank" download class="hidden px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600">Baixar PDF</a>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <section id="dashboard" class="section active-section">
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Resumo Gourmet</h1>
                    <p class="text-sm text-gray-500 mb-4">Seu ID de Usuário: <span id="user-id" class="font-mono">Carregando...</span></p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-rose-200 to-rose-100 p-6 rounded-2xl text-center shadow-md border border-rose-300">
                            <p class="text-lg text-gray-700">Vendas do Dia</p>
                            <p id="daily-sales" class="text-3xl font-bold text-rose-600">R$ 0,00</p>
                        </div>
                        <div class="bg-gradient-to-br from-fuchsia-200 to-fuchsia-100 p-6 rounded-2xl text-center shadow-md border border-fuchsia-300">
                            <p class="text-lg text-gray-700">Itens em Estoque</p>
                            <p id="total-stock-items" class="text-3xl font-bold text-fuchsia-600">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-pink-200 to-pink-100 p-6 rounded-2xl text-center shadow-md border border-pink-300">
                            <p class="text-lg text-lg text-gray-700">Alerta de Estoque Baixo</p>
                            <p id="low-stock-alert" class="text-3xl font-bold text-pink-600">0</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Vendas Section -->
            <section id="vendas" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Vendas e Orçamentos</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Detalhes da Transação</h2>
                    <form id="venda-form" class="space-y-4">
                        <div>
                            <label for="venda-cliente" class="block text-sm font-medium text-gray-700">Cliente (opcional)</label>
                            <select id="venda-cliente" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                <option value="">Selecionar Cliente</option>
                            </select>
                        </div>
                        <div>
                            <label for="venda-produto" class="block text-sm font-medium text-gray-700">Produto</label>
                            <select id="venda-produto" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                <option value="">Selecionar Produto</option>
                            </select>
                        </div>
                        <div>
                            <label for="venda-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                            <input type="number" id="venda-quantidade" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" value="1" min="1">
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" id="add-item" class="w-full py-3 bg-pink-500 text-white font-medium rounded-xl hover:bg-pink-600 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">Adicionar Item</button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Itens da Transação</h2>
                    <table class="min-w-full divide-y divide-gray-200 mb-4">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço Unitário</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 bg-gray-50"></th>
                            </tr>
                        </thead>
                        <tbody id="cart-items" class="bg-white divide-y divide-gray-200">
                            <!-- Cart items will be added here dynamically -->
                        </tbody>
                    </table>
                    
                    <div class="space-y-4 mt-6">
                        <div class="flex items-center space-x-4">
                            <div class="flex-1">
                                <label for="desconto-valor" class="block text-sm font-medium text-gray-700">Desconto (R$)</label>
                                <input type="number" id="desconto-valor" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                            </div>
                            <div class="flex-1">
                                <label for="desconto-porcentagem" class="block text-sm font-medium text-gray-700">Desconto (%)</label>
                                <input type="number" id="desconto-porcentagem" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                             <div class="flex-1">
                                 <label for="entrega-valor" class="block text-sm font-medium text-gray-700">Entrega (R$)</label>
                                 <input type="number" id="entrega-valor" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                             </div>
                           </div>
                        
                        <div class="flex justify-between items-center text-lg font-bold">
                            <span>Subtotal:</span>
                            <span id="cart-subtotal">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-green-600">
                            <span>Desconto:</span>
                            <span id="desconto-aplicado">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold text-blue-600">
                            <span>Entrega:</span>
                            <span id="entrega-valor-span">R$ 0,00</span>
                        </div>
                        <div class="flex justify-between items-center text-xl font-bold border-t pt-4">
                            <span>Total a Pagar:</span>
                            <span id="cart-total">R$ 0,00</span>
                        </div>
                    </div>

                    <div class="mt-6 flex space-x-4">
                        <div class="flex-1">
                             <label for="venda-pagamento" class="block text-sm font-medium text-gray-700 mb-2">Forma de Pagamento</label>
                             <select id="venda-pagamento" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                 <option value="Dinheiro">Dinheiro</option>
                                 <option value="Cartão">Cartão</option>
                                 <option value="Pix">Pix</option>
                             </select>
                        </div>
                        <button id="faturar-pedido-btn" class="flex-1 py-3 bg-pink-500 text-white rounded-xl font-medium hover:bg-pink-600 transition-colors duration-200 shadow-md">Faturar Pedido</button>
                    </div>
                    <div class="mt-4 flex space-x-4">
                          <button id="gerar-orcamento" class="flex-1 py-3 bg-fuchsia-500 text-white rounded-xl font-medium hover:bg-fuchsia-600 transition-colors duration-200 shadow-md">Gerar Orçamento</button>
                          <button id="limpar-carrinho" class="flex-1 py-3 bg-gray-500 text-white rounded-xl font-medium hover:bg-gray-600 transition-colors duration-200 shadow-md">Limpar</button>
                    </div>
                </div>
                
                <!-- Hidden container for PDF generation -->
                <div id="pdf-content" class="p-8 hidden">
                    <div class="border border-gray-300 rounded-lg p-6" id="pdf-border">
                         <div class="flex justify-between items-start mb-4">
                            <div class="text-left w-1/2">
                                <h1 class="text-xl font-bold branding-font mb-1" id="pdf-empresa-nome"></h1>
                                <p class="text-xs" id="pdf-empresa-endereco"></p>
                                <p class="text-xs" id="pdf-empresa-cnpj"></p>
                                <p class="text-xs" id="pdf-empresa-ie"></p>
                                <p class="text-xs" id="pdf-empresa-im"></p>
                            </div>
                            <div class="text-right w-1/2">
                                <div id="pdf-logo-container" class="w-20 h-20 ml-auto mb-2">
                                    <!-- Logo will be dynamically added here -->
                                </div>
                                <p class="text-sm">Data: <span id="pdf-date"></span></p>
                                <h2 class="text-2xl font-bold mt-2" id="pdf-type-title"></h2>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm">Cliente: <span id="pdf-customer"></span></p>
                        </div>

                        <table class="w-full text-left table-auto border-collapse mb-4">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-2 border-b-2">Item</th>
                                    <th class="p-2 border-b-2 text-right">Qtd</th>
                                    <th class="p-2 border-b-2 text-right">Valor Unit.</th>
                                    <th class="p-2 border-b-2 text-right">Total</th>
                                </tr>
                            </thead>
                            <tbody id="pdf-items">
                                <!-- Items go here -->
                            </tbody>
                        </table>
                        
                        <div class="flex justify-between items-center text-sm font-bold border-t pt-2">
                            <span>Subtotal:</span>
                            <span id="pdf-subtotal"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-bold">
                            <span>Desconto:</span>
                            <span id="pdf-desconto"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm font-bold">
                            <span>Entrega:</span>
                            <span id="pdf-entrega"></span>
                        </div>
                        <div class="flex justify-between items-center text-lg font-bold border-t pt-2 mt-2">
                            <span>TOTAL:</span>
                            <span id="pdf-total"></span>
                        </div>
                        <div class="mt-4">
                            <p class="text-sm font-semibold">Forma de Pagamento: <span class="font-normal" id="pdf-payment"></span></p>
                        </div>
                        <div class="mt-6 text-center text-sm space-y-1 text-gray-700">
                             <p id="pdf-instagram"></p>
                             <p id="pdf-whatsapp"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Histórico Section -->
            <section id="historico" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Histórico de Recibos e Orçamentos</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Buscar no Histórico</h2>
                    <div class="flex space-x-4 mb-4">
                        <div class="flex-1">
                            <label for="search-cliente" class="block text-sm font-medium text-gray-700">Buscar por Cliente</label>
                            <input type="text" id="search-cliente" placeholder="Nome do Cliente" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div class="flex-1">
                            <label for="search-data" class="block text-sm font-medium text-gray-700">Buscar por Data</label>
                            <input type="date" id="search-data" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div class="flex-1">
                            <label for="search-status" class="block text-sm font-medium text-gray-700">Status do Pagamento</label>
                            <select id="search-status" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                 <option value="todos">Todos</option>
                                 <option value="pago">Pago</option>
                                 <option value="a receber">A Receber</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lucro</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="bg-white divide-y divide-gray-200">
                            <!-- History items will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Estoque Section -->
            <section id="estoque" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Gestão de Estoque</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Adicionar/Editar Produto</h2>
                    <form id="estoque-form" class="space-y-4">
                        <input type="hidden" id="estoque-id">
                        <div>
                            <label for="estoque-nome" class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                            <input type="text" id="estoque-nome" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="estoque-preco" class="block text-sm font-medium text-gray-700">Preço de Venda</label>
                            <input type="number" id="estoque-preco" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="estoque-custo" class="block text-sm font-medium text-gray-700">Preço de Custo (opcional)</label>
                            <input type="number" id="estoque-custo" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="estoque-quantidade" class="block text-sm font-medium text-gray-700">Quantidade</label>
                            <input type="number" id="estoque-quantidade" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="estoque-minimo" class="block text-sm font-medium text-gray-700">Estoque Mínimo (Alerta)</label>
                            <input type="number" id="estoque-minimo" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" value="5">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Produto</button>
                    </form>
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h2 class="text-2xl font-semibold mb-4">Importar/Exportar Estoque</h2>
                        <div class="flex space-x-4 items-center">
                              <label for="excel-file-upload" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg cursor-pointer hover:bg-gray-300 transition-colors duration-200">
                                 <i class="fa-solid fa-file-excel mr-2"></i> Importar do Excel
                              </label>
                              <input type="file" id="excel-file-upload" class="hidden" accept=".xlsx, .xls, .csv">
                              <button id="export-excel-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-200">
                                 <i class="fa-solid fa-download mr-2"></i> Exportar para Excel
                              </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-semibold mb-4">Produtos no Estoque</h2>
                    <div id="low-stock-message" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 hidden" role="alert">
                        <p class="font-bold">Alerta de Estoque Baixo!</p>
                        <ul id="low-stock-list" class="mt-2 list-disc list-inside"></ul>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preço</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Custo</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qtd</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="product-list" class="bg-white divide-y divide-gray-200">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Clientes Section -->
            <section id="clientes" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Cadastro de Clientes</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Adicionar Cliente</h2>
                    <form id="cliente-form" class="space-y-4">
                        <div>
                            <label for="cliente-nome" class="block text-sm font-medium text-gray-700">Nome</label>
                            <input type="text" id="cliente-nome" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="cliente-contato" class="block text-sm font-medium text-gray-700">Contato (telefone)</label>
                            <input type="text" id="cliente-contato" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="cliente-email" class="block text-sm font-medium text-gray-700">E-mail (opcional)</label>
                            <input type="email" id="cliente-email" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="cliente-cpf" class="block text-sm font-medium text-gray-700">CPF (opcional)</label>
                            <input type="text" id="cliente-cpf" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div>
                            <label for="cliente-endereco" class="block text-sm font-medium text-gray-700">Endereço (opcional)</label>
                            <input type="text" id="cliente-endereco" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Cliente</button>
                    </form>
                </div>
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-semibold mb-4">Lista de Clientes</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contato</th>
                                <th class="px-6 py-3 bg-gray-50">E-mail</th>
                                <th class="px-6 py-3 bg-gray-50">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="customer-list" class="bg-white divide-y divide-gray-200">
                            <!-- Customers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Lembretes Section -->
            <section id="lembretes" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Lembretes de Pedidos</h1>
                
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 hidden" id="delivery-alert" role="alert">
                    <p class="font-bold">Atenção! Entregas a caminho:</p>
                    <ul id="delivery-list" class="mt-2 list-disc list-inside"></ul>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Adicionar Lembrete</h2>
                    <form id="lembrete-form" class="space-y-4">
                        <div>
                            <label for="lembrete-cliente" class="block text-sm font-medium text-gray-700">Cliente</label>
                            <select id="lembrete-cliente" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                                <option value="">Selecionar Cliente</option>
                            </select>
                        </div>
                        <div>
                            <label for="lembrete-data" class="block text-sm font-medium text-gray-700">Data de Entrega</label>
                            <input type="date" id="lembrete-data" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-xl font-semibold mb-2">Adicionar Itens do Pedido</h3>
                            <div class="flex space-x-2 mb-2">
                                <div class="flex-1">
                                    <label for="lembrete-produto" class="sr-only">Produto</label>
                                    <select id="lembrete-produto" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                        <option value="">Selecionar Produto</option>
                                    </select>
                                </div>
                                <div class="w-24">
                                    <label for="lembrete-quantidade-item" class="sr-only">Quantidade</label>
                                    <input type="number" id="lembrete-quantidade-item" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" value="1" min="1">
                                </div>
                                <button type="button" id="add-lembrete-item" class="p-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition-colors duration-200"><i class="fa-solid fa-plus"></i></button>
                            </div>
                            <ul id="lembrete-itens-list" class="list-disc list-inside space-y-1 text-gray-700">
                                <!-- Itens do lembrete serão inseridos aqui -->
                            </ul>
                            <div class="text-right font-bold text-lg mt-4">
                                Total do Pedido: <span id="lembrete-total-span">R$ 0,00</span>
                            </div>
                        </div>

                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Lembrete</button>
                    </form>
                </div>

                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-semibold mb-4">Lembretes Pendentes</h2>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalhes</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data de Entrega</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="lembretes-list" class="bg-white divide-y divide-gray-200">
                            <!-- Reminders will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <!-- Configurações Section -->
            <section id="configuracoes" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Configurações do Sistema</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl space-y-6">
                    <div>
                        <h2 class="text-2xl font-semibold mb-4">Personalizar Layout</h2>
                        <label for="main-color" class="block text-sm font-medium text-gray-700">Cor Principal do Sistema</label>
                        <input type="color" id="main-color" value="#be185d" class="mt-1 block w-full h-10 rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                    </div>
                    <div>
                        <label for="font-color" class="block text-sm font-medium text-gray-700">Cor da Fonte do Título</label>
                        <input type="color" id="font-color" value="#be185d" class="mt-1 block w-full h-10 rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                    </div>
                    
                    <div class="border-t pt-6 mt-6">
                        <h2 class="text-2xl font-semibold mb-4">Fundo da Tela de Login</h2>
                        <div class="space-y-2 mb-4">
                            <label for="login-bg-color" class="block text-sm font-medium text-gray-700">Cor de Fundo da Tela de Login</label>
                            <input type="color" id="login-bg-color" value="#f8fafc" class="mt-1 block w-full h-10 rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                        </div>
                        <div class="space-y-2">
                            <label for="login-bg-image" class="block text-sm font-medium text-gray-700">URL da Imagem de Fundo (opcional)</label>
                            <input type="text" id="login-bg-image" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" placeholder="Ex: https://exemplo.com/imagem.jpg">
                        </div>
                        <div class="space-y-2 mt-4">
                            <label for="login-bg-upload" class="block text-sm font-medium text-gray-700">Ou faça upload de uma imagem:</label>
                            <input type="file" id="login-bg-upload" accept="image/*" class="mt-1 block w-full">
                        </div>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h2 class="text-2xl font-semibold mb-4">Dados da Empresa para Recibo</h2>
                        <form id="company-data-form" class="space-y-4">
                            <div>
                                <label for="empresa-nome" class="block text-sm font-medium text-gray-700">Nome Fantasia</label>
                                <input type="text" id="empresa-nome" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                            </div>
                            <div>
                                <label for="empresa-endereco" class="block text-sm font-medium text-gray-700">Endereço</label>
                                <input type="text" id="empresa-endereco" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="empresa-cnpj" class="block text-sm font-medium text-gray-700">CNPJ</label>
                                    <input type="text" id="empresa-cnpj" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                </div>
                                <div>
                                    <label for="empresa-ie" class="block text-sm font-medium text-gray-700">Inscrição Estadual (IE)</label>
                                    <input type="text" id="empresa-ie" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                </div>
                                <div>
                                    <label for="empresa-im" class="block text-sm font-medium text-gray-700">Inscrição Municipal (IM)</label>
                                    <input type="text" id="empresa-im" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                </div>
                            </div>
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Dados da Empresa</button>
                        </form>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h2 class="text-2xl font-semibold mb-4">Informações de Contato</h2>
                        <form id="contact-form" class="space-y-4">
                            <div>
                                <label for="instagram" class="block text-sm font-medium text-gray-700">Instagram</label>
                                <input type="text" id="instagram" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" placeholder="@gourmetdamah">
                            </div>
                            <div>
                                <label for="whatsapp" class="block text-sm font-medium text-gray-700">WhatsApp</label>
                                <input type="text" id="whatsapp" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" placeholder="(xx) xxxxx-xxxx">
                            </div>
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Contato</button>
                        </form>
                    </div>

                    <div class="border-t pt-6 mt-6">
                        <h2 class="text-2xl font-semibold mb-4">Logo para Recibo</h2>
                        <div class="mb-4">
                              <label for="logo-upload" class="block text-sm font-medium text-gray-700">Escolha uma imagem de logo:</label>
                              <input type="file" id="logo-upload" accept="image/*" class="mt-1 block w-full">
                        </div>
                        <div class="w-40 h-40 bg-gray-100 rounded-lg flex items-center justify-center p-4 shadow-inner">
                            <img id="logo-preview" src="#" alt="Preview da Logo" class="max-w-full max-h-full hidden">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Financeiro Section -->
            <section id="financeiro" class="section">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Controle Financeiro</h1>
                <div class="bg-white rounded-3xl p-8 shadow-2xl mb-6">
                    <h2 class="text-2xl font-semibold mb-4">Lançar Transação</h2>
                    <form id="finance-form" class="space-y-4">
                        <div>
                            <label for="finance-type" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="finance-type" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                                <option value="entrada">Entrada</option>
                                <option value="saida">Saída</option>
                            </select>
                        </div>
                        <div>
                            <label for="finance-description" class="block text-sm font-medium text-gray-700">Descrição</label>
                            <input type="text" id="finance-description" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <div>
                            <label for="finance-amount" class="block text-sm font-medium text-gray-700">Valor</label>
                            <input type="number" id="finance-amount" step="0.01" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-pink-500 focus:ring-pink-500" required>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-pink-500 hover:bg-pink-600 transition-colors duration-200">Salvar Transação</button>
                    </form>
                </div>
                <div class="bg-white rounded-3xl p-8 shadow-2xl">
                    <h2 class="text-2xl font-semibold mb-4">Extrato Financeiro</h2>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-medium text-green-600">Entradas: <span id="total-entradas">R$ 0,00</span></p>
                        <p class="text-lg font-medium text-red-600">Saídas: <span id="total-saidas">R$ 0,00</span></p>
                        <p class="text-2xl font-bold">Saldo: <span id="saldo-total">R$ 0,00</span></p>
                    </div>
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descrição</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="finance-list" class="bg-white divide-y divide-gray-200">
                            <!-- Finance transactions will be populated here -->
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
        
    </div>
    <!-- Firebase and application logic -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app;
        let auth;
        let db;
        let userId = null;
        let authReady = false;

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM content loaded. Initializing Firebase...");
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                console.log("Auth state changed. User:", user ? user.uid : 'null');
                const landingPage = document.getElementById('landing-page');
                const mainAppContainer = document.getElementById('main-app-container');

                if (user) {
                    userId = user.uid;
                    const userIdSpan = document.getElementById('user-id');
                    if (userIdSpan) userIdSpan.textContent = userId;
                    authReady = true;
                    if (landingPage) landingPage.classList.add('hidden');
                    if (mainAppContainer) mainAppContainer.classList.remove('hidden');
                    
                    // Set initial active section to dashboard and render it
                    document.querySelectorAll('.section').forEach(section => section.classList.remove('active-section'));
                    const dashboardSection = document.getElementById('dashboard');
                    if (dashboardSection) dashboardSection.classList.add('active-section');
                    
                    initListeners();
                } else {
                    userId = null;
                    authReady = true;
                    if (mainAppContainer) mainAppContainer.classList.add('hidden');
                    if (landingPage) landingPage.classList.remove('hidden'); // Show Login Page
                }
            });

            // Helper function to check if the admin flag exists and who the admin is
            const getAdminStatus = async () => {
                const adminDocRef = doc(db, `artifacts/${appId}/admin/main`);
                try {
                    const adminDocSnap = await getDoc(adminDocRef);
                    return adminDocSnap.exists() ? adminDocSnap.data() : null;
                } catch (e) {
                    // This can happen if the security rules deny read access to a non-existent doc for non-admin users.
                    // We assume that if we can't read it, no admin has been set yet.
                    console.warn("Could not check admin status, assuming no admin exists yet. Error:", e.code);
                    return null;
                }
            };

            // Function to set the first user as admin
            const setAdminUser = async (uid) => {
                const adminDocRef = doc(db, `artifacts/${appId}/admin/main`);
                await setDoc(adminDocRef, { adminUid: uid, dateCreated: new Date().toISOString() });
            };

            // --- Authentication Event Listeners ---
            
            // LOGIN FORM SUBMIT
            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login failed:", error);
                    window.showModal('Erro de Login', 'Falha ao fazer login. Verifique suas credenciais e se a conta está cadastrada.');
                }
            });

            // REGISTER FORM SUBMIT
            const registerForm = document.getElementById('register-form');
            if (registerForm) registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;

                try {
                    const existingAdmin = await getAdminStatus();
                    
                    if (existingAdmin && existingAdmin.adminUid) {
                        // Admin already exists, proceed with normal registration
                        await createUserWithEmailAndPassword(auth, email, password);
                        window.showModal('Cadastro Concluído', 'Sua conta foi criada. Faça login para acessar o sistema.');
                    } else {
                        // First user registration
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const newUid = userCredential.user.uid;
                        
                        // Set this user as the admin/owner
                        await setAdminUser(newUid);

                        window.showModal('Cadastro e Admin Definido', 'Parabéns! Sua conta foi criada e você é o administrador do sistema. Faça login para acessar.');
                    }
                    
                    // Switch back to login form after successful registration/attempt
                    const loginForm = document.getElementById('login-form');
                    const registerForm = document.getElementById('register-form');
                    const toggleLink = document.getElementById('toggle-form-link');

                    if (loginForm && registerForm && toggleLink) {
                        loginForm.classList.remove('hidden');
                        registerForm.classList.add('hidden');
                        toggleLink.textContent = 'Não tem uma conta? Crie uma aqui.';
                    }

                } catch (error) {
                    console.error("Registration failed:", error);
                    let errorMessage = 'Falha ao cadastrar. Verifique o email e a senha.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'O email fornecido já está em uso.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'A senha deve ter pelo menos 6 caracteres.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'O formato do email é inválido.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Erro de rede. Verifique sua conexão ou as regras de segurança do Firebase.';
                    }
                    window.showModal('Erro de Cadastro', errorMessage);
                }
            });

            // FORM TOGGLE LINK (CORRIGIDO PARA MAIOR ROBUSTEZ)
            const toggleFormLink = document.getElementById('toggle-form-link');
            if (toggleFormLink) toggleFormLink.addEventListener('click', (e) => {
                e.preventDefault();
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');

                if (loginForm && registerForm) {
                    const isLoginFormVisible = !loginForm.classList.contains('hidden');

                    if (isLoginFormVisible) {
                        // Showing Register Form
                        loginForm.classList.add('hidden');
                        registerForm.classList.remove('hidden');
                        e.target.textContent = 'Já tem uma conta? Faça login aqui.';
                    } else {
                        // Showing Login Form
                        registerForm.classList.add('hidden');
                        loginForm.classList.remove('hidden');
                        e.target.textContent = 'Não tem uma conta? Crie uma aqui.';
                    }
                }
            });
            // --- End Authentication Event Listeners ---


            document.getElementById('logout-link').addEventListener('click', async (e) => {
                e.preventDefault();
                await signOut(auth);
            });

            window.data = {
                products: [],
                customers: [],
                history: [],
                finance: [],
                reminders: [],
                cart: [],
                reminderCart: [],
                config: {
                    color: '#be185d',
                    logo: '',
                    instagram: '',
                    whatsapp: '',
                    fontColor: '#be185d',
                    loginBgColor: '#f8fafc',
                    loginBgImage: '',
                    companyName: 'Gourmet da Mah',
                    companyAddress: '',
                    companyCnpj: '',
                    companyIe: '',
                    companyIm: ''
                }
            };

            const updateFirebaseDoc = async (collectionPath, id, data) => {
                if (!userId) {
                    console.error("User ID is not defined. Cannot update document.");
                    return;
                }
                const docRef = doc(db, collectionPath, id);
                try {
                    await updateDoc(docRef, data);
                } catch (e) {
                    console.error("Erro ao atualizar documento: ", e);
                }
            }

            const setFirebaseDoc = async (collectionPath, data) => {
                if (!userId) {
                    console.error("User ID is not defined. Cannot set document.");
                    return null;
                }
                const newDocRef = doc(collection(db, collectionPath));
                try {
                    await setDoc(newDocRef, data);
                    return newDocRef.id;
                } catch (e) {
                    console.error("Erro ao adicionar documento: ", e);
                    return null;
                }
            }

            const deleteFirebaseDoc = async (collectionPath, id) => {
                if (!userId) {
                    console.error("User ID is not defined. Cannot delete document.");
                    return;
                }
                const docRef = doc(db, collectionPath, id);
                try {
                    await deleteDoc(docRef);
                } catch (e) {
                    console.error("Erro ao deletar documento: ", e);
                }
            }

            window.initListeners = () => {
                console.log("Initializing listeners. Auth ready:", authReady, "User ID:", userId);
                if (!authReady || !userId) {
                    console.log("Listeners not started. Auth not ready or user ID missing.");
                    return;
                }

                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/products`), (snapshot) => {
                    window.data.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderEstoque();
                    renderVendas();
                    renderLembretes();
                    renderDashboard();
                });

                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/customers`), (snapshot) => {
                    window.data.customers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderClientes();
                    renderVendas();
                    renderLembretes();
                });

                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/history`), (snapshot) => {
                    window.data.history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderHistory();
                    renderDashboard();
                });

                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/finance`), (snapshot) => {
                    window.data.finance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFinanceiro();
                });

                onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/reminders`), (snapshot) => {
                    window.data.reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderLembretes();
                });

                const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                onSnapshot(configDocRef, (documentSnapshot) => {
                    if (documentSnapshot.exists()) {
                        window.data.config = documentSnapshot.data();
                    } else {
                        // Initialize config if it doesn't exist
                        setDoc(configDocRef, window.data.config);
                    }
                    updateColors();
                    renderConfiguracoes();
                });
            };

            window.showModal = (title, message, showPdfLink = false) => {
                const modalContainer = document.getElementById('modal-container');
                const modalTitle = document.getElementById('modal-title');
                const modalMessage = document.getElementById('modal-message');
                const modalPdfLink = document.getElementById('modal-pdf-link');
                if (modalTitle) modalTitle.textContent = title;
                if (modalMessage) modalMessage.textContent = message;
                if (modalPdfLink) {
                    if (showPdfLink) {
                        modalPdfLink.classList.remove('hidden');
                    } else {
                        modalPdfLink.classList.add('hidden');
                    }
                }
                if (modalContainer) modalContainer.classList.remove('hidden');
            };

            window.hideModal = () => {
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) modalContainer.classList.add('hidden');
            };

            window.removeItemFromCart = (index) => {
                window.data.cart.splice(index, 1);
                renderCartItems();
            };

            window.generatePdf = (transaction) => {
                const pdfContent = document.getElementById('pdf-content');
                if (!pdfContent) {
                    console.error("PDF content container not found.");
                    return;
                }
                document.getElementById('pdf-empresa-nome').textContent = window.data.config.companyName;
                document.getElementById('pdf-empresa-endereco').textContent = window.data.config.companyAddress;
                document.getElementById('pdf-empresa-cnpj').textContent = window.data.config.companyCnpj;
                document.getElementById('pdf-empresa-ie').textContent = window.data.config.companyIe;
                document.getElementById('pdf-empresa-im').textContent = window.data.config.companyIm;
                
                document.getElementById('pdf-type-title').textContent = transaction.type.toUpperCase();
                document.getElementById('pdf-date').textContent = transaction.date;
                document.getElementById('pdf-customer').textContent = transaction.customer;
                document.getElementById('pdf-payment').textContent = transaction.paymentMethod;
                document.getElementById('pdf-desconto').textContent = `R$ ${transaction.desconto.toFixed(2).replace('.', ',')}`;
                document.getElementById('pdf-entrega').textContent = `R$ ${transaction.entrega.toFixed(2).replace('.', ',')}`;
                document.getElementById('pdf-total').textContent = `R$ ${transaction.total.toFixed(2).replace('.', ',')}`;
                document.getElementById('pdf-subtotal').textContent = `R$ ${transaction.subtotal.toFixed(2).replace('.', ',')}`;
                
                const pdfItemsList = document.getElementById('pdf-items');
                pdfItemsList.innerHTML = '';
                transaction.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${item.name}</td>
                        <td class="p-2 text-right">${item.quantity}</td>
                        <td class="p-2 text-right">R$ ${item.price.toFixed(2).replace('.', ',')}</td>
                        <td class="p-2 text-right">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
                    `;
                    pdfItemsList.appendChild(row);
                });
                
                const pdfLogo = document.getElementById('pdf-logo-container');
                if (pdfLogo) {
                    pdfLogo.innerHTML = '';
                    if (window.data.config.logo) {
                        pdfLogo.innerHTML = `<img src="${window.data.config.logo}" alt="Logo" class="w-full h-full object-contain">`;
                    }
                }

                const pdfInstagram = document.getElementById('pdf-instagram');
                const pdfWhatsapp = document.getElementById('pdf-whatsapp');
                pdfInstagram.textContent = window.data.config.instagram ? `@${window.data.config.instagram}` : '';
                pdfWhatsapp.textContent = window.data.config.whatsapp ? `WhatsApp: ${window.data.config.whatsapp}` : '';

                pdfContent.style.display = 'block';

                window.jsPDF = window.jspdf.jsPDF;
                const doc = new window.jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });

                html2canvas(pdfContent, { scale: 2 }).then(canvas => {
                    if (!canvas || canvas.width === 0 || canvas.height === 0) {
                        console.error("Erro: O canvas gerado tem dimensões inválidas.");
                        window.showModal('Erro na Geração do PDF', 'Não foi possível gerar o PDF. A página de conteúdo estava vazia.');
                        pdfContent.style.display = 'none';
                        return;
                    }

                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = doc.internal.pageSize.getWidth();
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    if (isNaN(imgWidth) || isNaN(imgHeight)) {
                        console.error("Erro: Largura ou altura da imagem inválida.");
                        window.showModal('Erro na Geração do PDF', 'Não foi possível gerar o PDF devido a dimensões inválidas.');
                        pdfContent.style.display = 'none';
                        return;
                    }
                    
                    let heightLeft = imgHeight;
                    let position = 0;

                    doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                    heightLeft -= doc.internal.pageSize.getHeight();

                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        doc.addPage();
                        doc.addImage(imgData, 'JPEG', 0, position, imgWidth, imgHeight);
                        heightLeft -= doc.internal.pageSize.getHeight();
                    }
                    
                    const pdfBlob = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    const modalPdfLink = document.getElementById('modal-pdf-link');
                    if (modalPdfLink) {
                        modalPdfLink.href = pdfUrl;
                        modalPdfLink.download = `${transaction.type}-${transaction.id}.pdf`;
                    }
                    
                    showModal(`${transaction.type} Gerado!`, `Seu ${transaction.type} foi gerado com sucesso. Você pode baixá-lo e compartilhar via WhatsApp.`, true);
                    pdfContent.style.display = 'none';
                });
            };

            window.markAsPaid = async (id) => {
                await updateFirebaseDoc(`artifacts/${appId}/users/${userId}/history`, id, { status: 'pago' });

                const transaction = window.data.history.find(t => t.id === id);
                if (transaction) {
                     await setFirebaseDoc(`artifacts/${appId}/users/${userId}/finance`, {
                         type: 'entrada',
                         description: `Venda #${id} (paga)`,
                         amount: transaction.total,
                         date: new Date().toLocaleString()
                     });
                }
            };

            window.deleteHistoryItem = async (id) => {
                await deleteFirebaseDoc(`artifacts/${appId}/users/${userId}/history`, id);
            };

            window.editProduct = (id) => {
                const product = window.data.products.find(p => p.id === id);
                if (product) {
                    const estoqueId = document.getElementById('estoque-id');
                    const estoqueNome = document.getElementById('estoque-nome');
                    const estoquePreco = document.getElementById('estoque-preco');
                    const estoqueCusto = document.getElementById('estoque-custo');
                    const estoqueQuantidade = document.getElementById('estoque-quantidade');
                    const estoqueMinimo = document.getElementById('estoque-minimo');

                    if (estoqueId) estoqueId.value = product.id;
                    if (estoqueNome) estoqueNome.value = product.name;
                    if (estoquePreco) estoquePreco.value = product.price;
                    if (estoqueCusto) estoqueCusto.value = product.costPrice || '';
                    if (estoqueQuantidade) estoqueQuantidade.value = product.quantity;
                    if (estoqueMinimo) estoqueMinimo.value = product.minStock;
                }
            };
            
            window.deleteProduct = async (id) => {
                await deleteFirebaseDoc(`artifacts/${appId}/users/${userId}/products`, id);
            };

            window.deleteCustomer = async (id) => {
                await deleteFirebaseDoc(`artifacts/${appId}/users/${userId}/customers`, id);
            };
            
            window.deleteReminder = async (id) => {
                await deleteFirebaseDoc(`artifacts/${appId}/users/${userId}/reminders`, id);
            };

            window.updateColors = () => {
                const sidebarBranding = document.getElementById('sidebar-branding');
                const landingPage = document.getElementById('landing-page');

                if (!sidebarBranding || !landingPage) return;

                const color = window.data.config.color;
                const fontColor = window.data.config.fontColor;
                document.documentElement.style.setProperty('--main-color', color);
                
                const colorRgb = hexToRgb(color);
                const colorLight = `rgba(${colorRgb.r}, ${colorRgb.g}, ${colorRgb.b}, 0.2)`;
                
                document.body.style.backgroundColor = colorLight;
                const pdfBorder = document.getElementById('pdf-border');
                if (pdfBorder) pdfBorder.style.borderColor = color;
                
                sidebarBranding.style.color = fontColor;
                sidebarBranding.style.background = 'none';
                sidebarBranding.style.webkitBackgroundClip = 'unset';
                sidebarBranding.style.webkitTextFillColor = 'unset';
                
                const sidebarBg = document.getElementById('sidebar-bg');
                const colorLightHex = `#${color.substring(1).split('').map(c => c+c).join('')}`
                if (sidebarBg) sidebarBg.style.background = `linear-gradient(to bottom, ${color} 0%, ${colorLightHex} 100%)`;
                
                document.querySelectorAll('.sidebar-link').forEach(link => {
                    link.style.color = '#fff';
                });
                document.querySelectorAll('.sidebar-link.active').forEach(el => {
                    el.style.backgroundColor = color;
                    el.style.opacity = 0.8;
                });
                document.querySelectorAll('.sidebar-link:hover').forEach(el => {
                    el.style.backgroundColor = color;
                    el.style.opacity = 0.6;
                });

                // Update login page background
                const body = document.body;
                if (window.data.config.loginBgImage) {
                    body.style.backgroundImage = `url('${window.data.config.loginBgImage}')`;
                    body.style.backgroundSize = 'cover';
                    body.style.backgroundPosition = 'center';
                    body.style.backgroundRepeat = 'no-repeat';
                } else if (window.data.config.loginBgColor) {
                    body.style.backgroundImage = 'none';
                    body.style.backgroundColor = window.data.config.loginBgColor;
                }

                const style = document.createElement('style');
                style.innerHTML = `
                    .bg-pink-500 { background-color: ${color}; }
                    .hover\\:bg-pink-600:hover { background-color: ${color}; opacity: 0.8; }
                    .text-pink-500 { color: ${color}; }
                    .hover\\:text-pink-700:hover { color: ${color}; }
                    .focus\\:border-pink-500:focus { border-color: ${color}; }
                    .focus\\:ring-pink-500:focus { --tw-ring-color: ${color}; }
                    .from-rose-200 { --tw-gradient-from: rgba(${colorRgb.r}, ${colorRgb.g}, ${colorRgb.b}, 0.2); }
                    .to-rose-100 { --tw-gradient-to: rgba(${colorRgb.r}, ${colorRgb.g}, ${colorRgb.b}, 0.1); }
                    .from-rose-500 { --tw-gradient-from: ${color}; }
                    .to-fuchsia-600 { --tw-gradient-to: ${color}; }
                    .border-rose-300 { border-color: ${color}; }
                    .text-rose-600 { color: ${color}; }
                    .text-rose-100 { color: #fff; }
                    .hover\\:bg-rose-400:hover { background-color: ${color}; opacity: 0.6; }
                `;
                document.head.appendChild(style);
            };
            
            function hexToRgb(hex) {
                const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                hex = hex.replace(shorthandRegex, function(m, r, g, b) {
                    return r + r + g + g + b + b;
                });

                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }

            window.renderEstoque = () => {
                 const productList = document.getElementById('product-list');
                 const lowStockMessage = document.getElementById('low-stock-message');
                 const lowStockList = document.getElementById('low-stock-list');
                 
                if (!productList) return;

                productList.innerHTML = '';
                if (lowStockList) lowStockList.innerHTML = '';
                const lowStockProducts = window.data.products.filter(p => p.quantity <= p.minStock);
                
                if (lowStockProducts.length > 0) {
                    if (lowStockMessage) lowStockMessage.classList.remove('hidden');
                    lowStockProducts.forEach(p => {
                        const li = document.createElement('li');
                        li.textContent = `${p.name} (Qtd: ${p.quantity})`;
                        if (lowStockList) lowStockList.appendChild(li);
                    });
                } else {
                    if (lowStockMessage) lowStockMessage.classList.add('hidden');
                }

                window.data.products.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const custoDisplay = product.costPrice ? `R$ ${product.costPrice.toFixed(2).replace('.', ',')}` : '-';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">R$ ${product.price.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${custoDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${product.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editProduct('${product.id}')" class="text-yellow-600 hover:text-yellow-900 mr-2">Editar</button>
                            <button onclick="deleteProduct('${product.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    productList.appendChild(row);
                });
            };

            window.renderVendas = () => {
                 const vendaProdutoSelect = document.getElementById('venda-produto');
                 const vendaClienteSelect = document.getElementById('venda-cliente');
                
                if (!vendaProdutoSelect || !vendaClienteSelect) return;

                vendaProdutoSelect.innerHTML = '<option value="">Selecionar Produto</option>';
                window.data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name}`;
                    vendaProdutoSelect.appendChild(option);
                });
                vendaClienteSelect.innerHTML = '<option value="">Selecionar Cliente</option>';
                window.data.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    vendaClienteSelect.appendChild(option);
                });
                renderCartItems();
            };

            window.renderCartItems = () => {
                 const cartItemsList = document.getElementById('cart-items');
                 if (!cartItemsList) return;
                
                cartItemsList.innerHTML = '';
                window.data.cart.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap">R$ ${item.price.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">R$ ${item.total.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button type="button" onclick="removeItemFromCart(${index})" class="text-red-600 hover:text-red-900">Remover</button>
                        </td>
                    `;
                    cartItemsList.appendChild(row);
                });
                updateCartTotals();
            };

            window.updateCartTotals = () => {
                 const descontoValorInput = document.getElementById('desconto-valor');
                 const descontoPorcentagemInput = document.getElementById('desconto-porcentagem');
                 const entregaValorInput = document.getElementById('entrega-valor');
                 const cartSubtotalSpan = document.getElementById('cart-subtotal');
                 const descontoAplicadoSpan = document.getElementById('desconto-aplicado');
                 const entregaValorSpan = document.getElementById('entrega-valor-span');
                 const cartTotalSpan = document.getElementById('cart-total');
                 const faturarPedidoBtn = document.getElementById('faturar-pedido-btn');
                
                const subtotal = window.data.cart.reduce((sum, item) => sum + item.total, 0);
                
                let desconto = 0;
                const descontoValor = parseFloat(descontoValorInput.value) || 0;
                const descontoPorcentagem = parseFloat(descontoPorcentagemInput.value) || 0;
                const entregaValor = parseFloat(entregaValorInput.value) || 0;
                
                if (descontoValor > 0) {
                    desconto = descontoValor;
                    if (descontoPorcentagemInput) descontoPorcentagemInput.value = '';
                } else if (descontoPorcentagem > 0) {
                    desconto = subtotal * (descontoPorcentagem / 100);
                    if (descontoValorInput) descontoValorInput.value = '';
                }
                
                const total = subtotal - desconto + entregaValor;

                if (cartSubtotalSpan) cartSubtotalSpan.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
                if (descontoAplicadoSpan) descontoAplicadoSpan.textContent = `R$ ${desconto.toFixed(2).replace('.', ',')}`;
                if (entregaValorSpan) entregaValorSpan.textContent = `R$ ${entregaValor.toFixed(2).replace('.', ',')}`;
                if (cartTotalSpan) cartTotalSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                
                if (faturarPedidoBtn) faturarPedidoBtn.disabled = window.data.cart.length === 0;
            };

            window.renderHistory = (historyToRender = window.data.history) => {
                 const historyList = document.getElementById('history-list');
                if (!historyList) return;
                
                historyList.innerHTML = '';
                historyToRender.forEach((t) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const statusColor = t.status === 'a receber' ? 'text-red-500' : 'text-green-500';
                    const statusText = t.status === 'a receber' ? 'A Receber' : 'Pago';
                    const actions = t.status === 'a receber' 
                        ? `<button onclick="markAsPaid('${t.id}')" class="text-green-600 hover:text-green-900 mr-2">Marcar como Pago</button>` 
                        : '';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${t.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.customer}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">R$ ${t.total.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-green-600">R$ ${t.profit.toFixed(2).replace('.', ',')}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-bold ${statusColor}">${statusText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="generatePdf(window.data.history.find(h => h.id === '${t.id}'))" class="text-pink-500 hover:text-pink-700 mr-2">Ver PDF</button>
                            ${actions}
                            <button onclick="deleteHistoryItem('${t.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    historyList.appendChild(row);
                });
            };
            
            window.renderClientes = () => {
                 const customerList = document.getElementById('customer-list');
                if (!customerList) return;
                
                customerList.innerHTML = '';
                window.data.customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${customer.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.contact}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${customer.email || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    customerList.appendChild(row);
                });
            };

            const renderReminderItems = () => {
                const lembreteItemsList = document.getElementById('lembrete-itens-list');
                const lembreteTotalSpan = document.getElementById('lembrete-total-span');

                if (!lembreteItemsList || !lembreteTotalSpan) return;

                lembreteItemsList.innerHTML = '';
                let total = 0;

                window.data.reminderCart.forEach((item, index) => {
                    total += item.total;
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `
                        <span>${item.name} (${item.quantity}) - R$ ${item.total.toFixed(2).replace('.', ',')}</span>
                        <button type="button" onclick="removeReminderItem(${index})" class="text-red-500 hover:text-red-700 ml-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    `;
                    lembreteItemsList.appendChild(li);
                });

                lembreteTotalSpan.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            };

            window.removeReminderItem = (index) => {
                window.data.reminderCart.splice(index, 1);
                renderReminderItems();
            };

            window.renderLembretes = () => {
                const lembreteForm = document.getElementById('lembrete-form');
                if (!lembreteForm) return;

                const lembreteClienteSelect = document.getElementById('lembrete-cliente');
                if(lembreteClienteSelect) {
                    lembreteClienteSelect.innerHTML = '<option value="">Selecionar Cliente</option>';
                    window.data.customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = customer.name;
                        lembreteClienteSelect.appendChild(option);
                    });
                }

                const lembreteProdutoSelect = document.getElementById('lembrete-produto');
                if (lembreteProdutoSelect) {
                    lembreteProdutoSelect.innerHTML = '<option value="">Selecionar Produto</option>';
                    window.data.products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (R$ ${product.price.toFixed(2).replace('.',',')})`;
                        lembreteProdutoSelect.appendChild(option);
                    });
                }

                const lembretesList = document.getElementById('lembretes-list');
                if (lembretesList) lembretesList.innerHTML = '';

                const deliveryAlert = document.getElementById('delivery-alert');
                const deliveryList = document.getElementById('delivery-list');
                if(deliveryList) deliveryList.innerHTML = '';
                const today = new Date();
                const oneWeek = new Date(today);
                oneWeek.setDate(today.getDate() + 7);

                const upcomingDeliveries = window.data.reminders.filter(r => {
                    const deliveryDate = new Date(r.dataDeEntrega);
                    return deliveryDate >= today && deliveryDate <= oneWeek && r.status === 'pendente';
                }).sort((a,b) => new Date(a.dataDeEntrega) - new Date(b.dataDeEntrega));

                if(upcomingDeliveries.length > 0) {
                    if(deliveryAlert) deliveryAlert.classList.remove('hidden');
                    upcomingDeliveries.forEach(r => {
                        const li = document.createElement('li');
                        const customer = window.data.customers.find(c => c.id === r.clienteId)?.name || 'Cliente não encontrado';
                        const deliveryDate = new Date(r.dataDeEntrega).toLocaleDateString('pt-BR');
                        const itemsText = r.items.map(item => `${item.name} (${item.quantity})`).join(', ');
                        li.innerHTML = `Pedido para **${customer}** em ${deliveryDate} - ${itemsText}`;
                        if(deliveryList) deliveryList.appendChild(li);
                    });
                } else {
                    if (deliveryAlert) deliveryAlert.classList.add('hidden');
                }
                
                window.data.reminders.filter(r => r.status === 'pendente').forEach(reminder => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const customerName = window.data.customers.find(c => c.id === reminder.clienteId)?.name || 'Não informado';
                    const totalDisplay = reminder.valor ? `R$ ${reminder.valor.toFixed(2).replace('.', ',')}` : '-';
                    const itemsText = reminder.items.map(item => `${item.name} (${item.quantity})`).join(', ');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${customerName}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${itemsText}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${new Date(reminder.dataDeEntrega).toLocaleDateString('pt-BR')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${totalDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="finalizarPedidoFromReminder('${reminder.id}')" class="text-green-600 hover:text-green-900 mr-2">Finalizar Pedido</button>
                            <button onclick="deleteReminder('${reminder.id}')" class="text-red-600 hover:text-red-900">Excluir</button>
                        </td>
                    `;
                    if(lembretesList) lembretesList.appendChild(row);
                });
            };

            window.finalizarPedidoFromReminder = async (id) => {
                const reminder = window.data.reminders.find(r => r.id === id);
                if (!reminder) return;
                const customerName = window.data.customers.find(c => c.id === reminder.clienteId)?.name || 'Não informado';

                // Criar um novo array de items para a transação, calculando o lucro
                const transactionItems = reminder.items.map(item => {
                    const stockProduct = window.data.products.find(p => p.id === item.id);
                    const costPrice = stockProduct ? stockProduct.costPrice || 0 : 0;
                    return {
                        ...item,
                        costPrice: costPrice
                    };
                });
                
                const totalCost = transactionItems.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
                const profit = reminder.valor - totalCost;
                
                const transaction = {
                    type: 'Recibo',
                    customer: customerName,
                    date: new Date().toLocaleString(),
                    items: transactionItems,
                    subtotal: reminder.valor,
                    total: reminder.valor,
                    profit: profit,
                    paymentMethod: 'Aguardando Pagamento',
                    desconto: 0,
                    entrega: 0,
                    status: 'a receber',
                    obs: `Pedido criado a partir de um lembrete.`
                };

                const newHistoryId = await setFirebaseDoc(`artifacts/${appId}/users/${userId}/history`, transaction);

                if (newHistoryId) {
                    await updateFirebaseDoc(`artifacts/${appId}/users/${userId}/reminders`, id, { status: 'concluido' });
                    const newTransaction = { ...transaction, id: newHistoryId };
                    window.generatePdf(newTransaction);
                }
            };
            
            window.renderConfiguracoes = () => {
                const mainColorInput = document.getElementById('main-color');
                const fontColorInput = document.getElementById('font-color');
                const loginBgColorInput = document.getElementById('login-bg-color');
                const loginBgImageInput = document.getElementById('login-bg-image');
                const companyNameInput = document.getElementById('empresa-nome');
                const companyAddressInput = document.getElementById('empresa-endereco');
                const companyCnpjInput = document.getElementById('empresa-cnpj');
                const companyIeInput = document.getElementById('empresa-ie');
                const companyImInput = document.getElementById('empresa-im');
                const instagramInput = document.getElementById('instagram');
                const whatsappInput = document.getElementById('whatsapp');
                const logoPreview = document.getElementById('logo-preview');

                if (mainColorInput) mainColorInput.value = window.data.config.color;
                if (fontColorInput) fontColorInput.value = window.data.config.fontColor;
                if (loginBgColorInput) loginBgColorInput.value = window.data.config.loginBgColor;
                if (loginBgImageInput) loginBgImageInput.value = window.data.config.loginBgImage;
                if (companyNameInput) companyNameInput.value = window.data.config.companyName;
                if (companyAddressInput) companyAddressInput.value = window.data.config.companyAddress;
                if (companyCnpjInput) companyCnpjInput.value = window.data.config.companyCnpj;
                if (companyIeInput) companyIeInput.value = window.data.config.companyIe;
                if (companyImInput) companyImInput.value = window.data.config.companyIm;
                if (instagramInput) instagramInput.value = window.data.config.instagram;
                if (whatsappInput) whatsappInput.value = window.data.config.whatsapp;
                
                if (logoPreview) {
                    if (window.data.config.logo) {
                        logoPreview.src = window.data.config.logo;
                        logoPreview.classList.remove('hidden');
                    } else {
                        logoPreview.classList.add('hidden');
                    }
                }
            };

            window.renderFinanceiro = () => {
                const financeList = document.getElementById('finance-list');
                const totalEntradasSpan = document.getElementById('total-entradas');
                const totalSaidasSpan = document.getElementById('total-saidas');
                const saldoTotalSpan = document.getElementById('saldo-total');

                if (!financeList) return;

                financeList.innerHTML = '';
                let totalEntradas = 0;
                let totalSaidas = 0;

                window.data.finance.forEach(transaction => {
                    if (transaction.type === 'entrada') {
                        totalEntradas += transaction.amount;
                    } else {
                        totalSaidas += transaction.amount;
                    }
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const valueClass = transaction.type === 'entrada' ? 'text-green-600' : 'text-red-600';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${transaction.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${transaction.type === 'entrada' ? 'Entrada' : 'Saída'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${transaction.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap font-semibold ${valueClass}">R$ ${transaction.amount.toFixed(2).replace('.', ',')}</td>
                    `;
                    financeList.appendChild(row);
                });

                const saldo = totalEntradas - totalSaidas;
                if (totalEntradasSpan) totalEntradasSpan.textContent = `R$ ${totalEntradas.toFixed(2).replace('.', ',')}`;
                if (totalSaidasSpan) totalSaidasSpan.textContent = `R$ ${totalSaidas.toFixed(2).replace('.', ',')}`;
                if (saldoTotalSpan) saldoTotalSpan.textContent = `R$ ${saldo.toFixed(2).replace('.', ',')}`;
            };

            window.renderDashboard = () => {
                const dailySalesSpan = document.getElementById('daily-sales');
                const totalStockItemsSpan = document.getElementById('total-stock-items');
                const lowStockAlertSpan = document.getElementById('low-stock-alert');

                if (!dailySalesSpan || !totalStockItemsSpan || !lowStockAlertSpan) return;
                
                const today = new Date().toLocaleDateString('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit' });
                
                const dailySales = window.data.history.filter(t => 
                    t.status === 'pago' && t.date.startsWith(today)
                ).reduce((sum, transaction) => sum + transaction.total, 0);

                dailySalesSpan.textContent = `R$ ${dailySales.toFixed(2).replace('.', ',')}`;
                totalStockItemsSpan.textContent = window.data.products.length;
                const lowStockCount = window.data.products.filter(p => p.quantity <= p.minStock).length;
                lowStockAlertSpan.textContent = lowStockCount;
            };

            const descontoValorInput = document.getElementById('desconto-valor');
            if (descontoValorInput) descontoValorInput.addEventListener('input', window.updateCartTotals);
            const descontoPorcentagemInput = document.getElementById('desconto-porcentagem');
            if (descontoPorcentagemInput) descontoPorcentagemInput.addEventListener('input', window.updateCartTotals);
            const entregaValorInput = document.getElementById('entrega-valor');
            if (entregaValorInput) entregaValorInput.addEventListener('input', window.updateCartTotals);
            const addItemBtn = document.getElementById('add-item');
            if (addItemBtn) addItemBtn.addEventListener('click', () => {
                const vendaProdutoSelect = document.getElementById('venda-produto');
                const vendaQuantidadeInput = document.getElementById('venda-quantidade');

                if (!vendaProdutoSelect || !vendaQuantidadeInput) return;

                const productId = vendaProdutoSelect.value;
                const product = window.data.products.find(p => p.id === productId);
                const quantity = parseInt(vendaQuantidadeInput.value);
                
                if (!product || quantity <= 0) {
                    window.showModal('Erro', 'Por favor, selecione um produto e uma quantidade válida.');
                    return;
                }
                if (quantity > product.quantity) {
                        window.showModal('Erro', 'Quantidade em estoque insuficiente.');
                        return;
                }
                const existingItem = window.data.cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    window.data.cart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        costPrice: product.costPrice || 0,
                        quantity: quantity,
                        total: quantity * product.price,
                    });
                }
                window.renderCartItems();
            });

            const faturarPedidoBtn = document.getElementById('faturar-pedido-btn');
            if (faturarPedidoBtn) faturarPedidoBtn.addEventListener('click', () => generateTransaction('Recibo', 'pago'));
            const gerarOrcamentoBtn = document.getElementById('gerar-orcamento');
            if (gerarOrcamentoBtn) gerarOrcamentoBtn.addEventListener('click', () => generateTransaction('Orçamento', 'a receber'));
            
            const limparCarrinhoBtn = document.getElementById('limpar-carrinho');
            if (limparCarrinhoBtn) limparCarrinhoBtn.addEventListener('click', () => {
                window.data.cart = [];
                const descontoValorInput = document.getElementById('desconto-valor');
                if (descontoValorInput) descontoValorInput.value = '';
                const descontoPorcentagemInput = document.getElementById('desconto-porcentagem');
                if (descontoPorcentagemInput) descontoPorcentagemInput.value = '';
                const entregaValorInput = document.getElementById('entrega-valor');
                if (entregaValorInput) entregaValorInput.value = '';
                window.renderCartItems();
            });

            const generateTransaction = async (type, status) => {
                if (window.data.cart.length === 0) {
                    window.showModal('Atenção', `Adicione itens ao carrinho para gerar um ${type}.`);
                    return;
                }
                const subtotal = window.data.cart.reduce((sum, item) => sum + item.total, 0);
                const entrega = parseFloat(document.getElementById('entrega-valor').value) || 0;
                let desconto = 0;
                const descontoValor = parseFloat(document.getElementById('desconto-valor').value) || 0;
                const descontoPorcentagem = parseFloat(document.getElementById('desconto-porcentagem').value) || 0;
                if (descontoValor > 0) {
                    desconto = descontoValor;
                } else if (descontoPorcentagem > 0) {
                    desconto = subtotal * (descontoPorcentagem / 100);
                }
                const total = subtotal - desconto + entrega;
                const totalCost = window.data.cart.reduce((sum, item) => sum + (item.costPrice * item.quantity), 0);
                const profit = total - totalCost;
                const customerId = document.getElementById('venda-cliente').value;
                const customerName = customerId ? window.data.customers.find(c => c.id === customerId)?.name : 'Não informado';
                const paymentMethod = document.getElementById('venda-pagamento').value;
                const transaction = {
                    type: type,
                    customer: customerName,
                    date: new Date().toLocaleString(),
                    items: JSON.parse(JSON.stringify(window.data.cart)),
                    subtotal: subtotal,
                    total: total,
                    profit: profit,
                    paymentMethod: paymentMethod,
                    desconto: desconto,
                    entrega: entrega,
                    status: status
                };
                if (type === 'Recibo') {
                        for (const cartItem of window.data.cart) {
                            const product = window.data.products.find(p => p.id === cartItem.id);
                            if (product) {
                                const newQuantity = product.quantity - cartItem.quantity;
                                await updateFirebaseDoc(`artifacts/${appId}/users/${userId}/products`, product.id, { quantity: newQuantity });
                            }
                        }
                    const newHistoryId = await setFirebaseDoc(`artifacts/${appId}/users/${userId}/history`, transaction);
                    if (newHistoryId) {
                        const newTransaction = { ...transaction, id: newHistoryId };
                        window.generatePdf(newTransaction);
                    }
                    if (status === 'pago') {
                            await setFirebaseDoc(`artifacts/${appId}/users/${userId}/finance`, {
                                type: 'entrada',
                                description: `Venda #${newHistoryId}`,
                                amount: total,
                                date: transaction.date
                            });
                    }
                } else if (type === 'Orçamento') {
                    const newHistoryId = await setFirebaseDoc(`artifacts/${appId}/users/${userId}/history`, transaction);
                    if (newHistoryId) {
                        const newTransaction = { ...transaction, id: newHistoryId };
                        window.generatePdf(newTransaction);
                    }
                }
                window.data.cart = [];
                const descontoValorInput = document.getElementById('desconto-valor');
                if (descontoValorInput) descontoValorInput.value = '';
                const descontoPorcentagemInput = document.getElementById('desconto-porcentagem');
                if (descontoPorcentagemInput) descontoPorcentagemInput.value = '';
                const entregaValorInput = document.getElementById('entrega-valor');
                if (entregaValorInput) entregaValorInput.value = '';
                window.renderCartItems();
            };

            const searchClienteInput = document.getElementById('search-cliente');
            const searchDateInput = document.getElementById('search-data');
            const searchStatusSelect = document.getElementById('search-status');

            const filterHistory = () => {
                const clienteSearch = (searchClienteInput ? searchClienteInput.value.toLowerCase() : '');
                const dateSearch = (searchDateInput ? searchDateInput.value : '');
                const statusSearch = (searchStatusSelect ? searchStatusSelect.value : 'todos');

                const filteredHistory = window.data.history.filter(t => {
                    const matchesCliente = clienteSearch === '' || t.customer.toLowerCase().includes(clienteSearch);
                    const matchesDate = dateSearch === '' || t.date.startsWith(dateSearch.split('-').reverse().join('/'));
                    const matchesStatus = statusSearch === 'todos' || t.status === statusSearch;
                    return matchesCliente && matchesDate && matchesStatus;
                });
                window.renderHistory(filteredHistory);
            };

            if (searchClienteInput) searchClienteInput.addEventListener('input', filterHistory);
            if (searchDateInput) searchDateInput.addEventListener('change', filterHistory);
            if (searchStatusSelect) searchStatusSelect.addEventListener('change', filterHistory);

            const excelFileUpload = document.getElementById('excel-file-upload');
            if (excelFileUpload) excelFileUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const workbook = XLSX.read(event.target.result, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonProducts = XLSX.utils.sheet_to_json(worksheet);
                    for (const row of jsonProducts) {
                        await setFirebaseDoc(`artifacts/${appId}/users/${userId}/products`, {
                            name: row.Nome || '',
                            price: parseFloat(row.Preço) || 0,
                            costPrice: parseFloat(row['Preço de Custo']) || null,
                            quantity: parseInt(row.Quantidade) || 0,
                            minStock: parseInt(row['Estoque Mínimo']) || 5
                        });
                    }
                    window.showModal('Importação Concluída', 'O estoque foi importado com sucesso!');
                };
                reader.readAsBinaryString(file);
            });

            const exportExcelBtn = document.getElementById('export-excel-btn');
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', () => {
                const productsToExport = window.data.products.map(p => ({
                    Nome: p.name,
                    Preço: p.price,
                    'Preço de Custo': p.costPrice || '-',
                    Quantidade: p.quantity,
                    'Estoque Mínimo': p.minStock
                }));
                const worksheet = XLSX.utils.json_to_sheet(productsToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Estoque');
                XLSX.writeFile(workbook, 'estoque_gourmet_da_mah.xlsx');
            });

            const estoqueForm = document.getElementById('estoque-form');
            if (estoqueForm) estoqueForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('estoque-id').value;
                const name = document.getElementById('estoque-nome').value;
                const price = parseFloat(document.getElementById('estoque-preco').value);
                const costPrice = parseFloat(document.getElementById('estoque-custo').value) || null;
                const quantity = parseInt(document.getElementById('estoque-quantidade').value);
                const minStock = parseInt(document.getElementById('estoque-minimo').value);
                if (id) {
                    await updateFirebaseDoc(`artifacts/${appId}/users/${userId}/products`, id, { name, price, costPrice, quantity, minStock });
                } else {
                    await setFirebaseDoc(`artifacts/${appId}/users/${userId}/products`, { name, price, costPrice, quantity, minStock });
                }
                estoqueForm.reset();
                document.getElementById('estoque-id').value = '';
            });

            const clienteForm = document.getElementById('cliente-form');
            if (clienteForm) clienteForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('cliente-nome').value;
                const contact = document.getElementById('cliente-contato').value;
                const email = document.getElementById('cliente-email').value || null;
                const cpf = document.getElementById('cliente-cpf').value || null;
                const endereco = document.getElementById('cliente-endereco').value || null;
                await setFirebaseDoc(`artifacts/${appId}/users/${userId}/customers`, { name, contact, email, cpf, endereco });
                clienteForm.reset();
            });

            const addLembreteItemBtn = document.getElementById('add-lembrete-item');
            if (addLembreteItemBtn) addLembreteItemBtn.addEventListener('click', () => {
                const lembreteProdutoSelect = document.getElementById('lembrete-produto');
                const lembreteQuantidadeInput = document.getElementById('lembrete-quantidade-item');

                if (!lembreteProdutoSelect || !lembreteQuantidadeInput) return;

                const productId = lembreteProdutoSelect.value;
                const product = window.data.products.find(p => p.id === productId);
                const quantity = parseInt(lembreteQuantidadeInput.value);

                if (!product || quantity <= 0) {
                    window.showModal('Erro', 'Por favor, selecione um produto e uma quantidade válida.');
                    return;
                }
                if (quantity > product.quantity) {
                    window.showModal('Erro', 'Quantidade em estoque insuficiente.');
                    return;
                }
                
                const existingItem = window.data.reminderCart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                    existingItem.total = existingItem.quantity * existingItem.price;
                } else {
                    window.data.reminderCart.push({
                        id: product.id,
                        name: product.name,
                        price: product.price,
                        costPrice: product.costPrice || 0,
                        quantity: quantity,
                        total: quantity * product.price
                    });
                }
                renderReminderItems();
                lembreteProdutoSelect.value = '';
                lembreteQuantidadeInput.value = '1';
            });

            const lembreteForm = document.getElementById('lembrete-form');
            if (lembreteForm) lembreteForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const clienteId = document.getElementById('lembrete-cliente').value;
                const dataDeEntrega = document.getElementById('lembrete-data').value;
                const totalPedido = window.data.reminderCart.reduce((sum, item) => sum + item.total, 0);

                if (!clienteId || window.data.reminderCart.length === 0 || !dataDeEntrega) {
                    window.showModal('Erro', 'Por favor, preencha todos os campos obrigatórios e adicione pelo menos um item.');
                    return;
                }
                
                const reminder = {
                    clienteId,
                    dataDeEntrega,
                    items: JSON.parse(JSON.stringify(window.data.reminderCart)),
                    valor: totalPedido,
                    status: 'pendente'
                };

                await setFirebaseDoc(`artifacts/${appId}/users/${userId}/reminders`, reminder);
                lembreteForm.reset();
                window.data.reminderCart = [];
                renderReminderItems();
            });

            const mainColorInput = document.getElementById('main-color');
            if (mainColorInput) mainColorInput.addEventListener('input', async (e) => {
                if (userId) {
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                    await updateDoc(configDocRef, { color: e.target.value });
                }
            });
            
            const fontColorInput = document.getElementById('font-color');
            if (fontColorInput) fontColorInput.addEventListener('input', async (e) => {
                if (userId) {
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                    await updateDoc(configDocRef, { fontColor: e.target.value });
                }
            });
            
            const loginBgColorInput = document.getElementById('login-bg-color');
            if(loginBgColorInput) loginBgColorInput.addEventListener('input', async (e) => {
                if(userId) {
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                    await updateDoc(configDocRef, { loginBgColor: e.target.value, loginBgImage: '' });
                }
            });

            const loginBgImageInput = document.getElementById('login-bg-image');
            if(loginBgImageInput) loginBgImageInput.addEventListener('blur', async (e) => {
                if(userId) {
                    const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                    await updateDoc(configDocRef, { loginBgImage: e.target.value, loginBgColor: '' });
                }
            });

            const loginBgUpload = document.getElementById('login-bg-upload');
            if(loginBgUpload) loginBgUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        if(userId) {
                           const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                           await updateDoc(configDocRef, { loginBgImage: event.target.result, loginBgColor: '' });
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            const companyDataForm = document.getElementById('company-data-form');
            if(companyDataForm) companyDataForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if(!userId) return;
                const companyName = document.getElementById('empresa-nome').value;
                const companyAddress = document.getElementById('empresa-endereco').value;
                const companyCnpj = document.getElementById('empresa-cnpj').value;
                const companyIe = document.getElementById('empresa-ie').value;
                const companyIm = document.getElementById('empresa-im').value;
                const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                await updateDoc(configDocRef, { companyName, companyAddress, companyCnpj, companyIe, companyIm });
                window.showModal('Salvo!', 'Os dados da empresa foram salvos com sucesso.');
            });

            const contactForm = document.getElementById('contact-form');
            if (contactForm) contactForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!userId) return;
                const instagram = document.getElementById('instagram').value;
                const whatsapp = document.getElementById('whatsapp').value;
                const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                await updateDoc(configDocRef, { instagram, whatsapp });
                window.showModal('Salvo!', 'As informações de contato foram salvas com sucesso.');
            });

            const logoUploadInput = document.getElementById('logo-upload');
            if (logoUploadInput) logoUploadInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file && userId) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const logo = event.target.result;
                        const configDocRef = doc(db, `artifacts/${appId}/users/${userId}/config/main`);
                        await updateDoc(configDocRef, { logo });
                        window.showModal('Logo Salva!', 'A imagem da sua logo foi salva com sucesso.');
                    };
                    reader.readAsDataURL(file);
                }
            });

            const financeForm = document.getElementById('finance-form');
            if (financeForm) financeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const type = document.getElementById('finance-type').value;
                const description = document.getElementById('finance-description').value;
                const amount = parseFloat(document.getElementById('finance-amount').value);
                if (amount <= 0) {
                    window.showModal('Erro', 'O valor deve ser maior que zero.');
                    return;
                }
                await setFirebaseDoc(`artifacts/${appId}/users/${userId}/finance`, {
                    type,
                    description,
                    amount,
                    date: new Date().toLocaleString()
                });
                financeForm.reset();
            });
        });
    </script>
</body>
</html>
